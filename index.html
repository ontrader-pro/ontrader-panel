<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>OnTrader Index Panel (Binance Only)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style>
    html, body { margin:0; padding:0; background:#101729; color:#fff; font-family:sans-serif; }
    h1 { color:#25f0ff; text-align:center; font-size:1.5rem; margin:0; padding:10px; }
    #panel { padding:0 10px; }
    table { width:100%; border-collapse:collapse; margin:20px 0; font-size:0.93rem; }
    th, td { border:1px solid #333; padding:6px; text-align:center; }
    thead { background:#1f2a44; color:#25f0ff; }
    .high { color:limegreen; }
    .mid { color:orange; }
    .low { color:red; }
    .highlight-bull { background:rgba(0,255,0,0.14); }
    .highlight-bear { background:rgba(255,0,0,0.15); }
    #error-box { color:#f55; text-align:center; }
    #formula { color:#aaa; text-align:center; font-size:0.92rem; }
    .oldscore { font-size:0.9em; color:#aaa; }
    #alerts { font-size:0.95em; }
    #alerts th, #alerts td { padding:4px 6px; }
    .alert-row { background:#272a39; }
  </style>
</head>
<body>
  <h1>OnTrader Index Panel (Binance Futures)</h1>
  <div id="formula">
    <strong>Score:</strong><br>
    1) Precio &gt; m√≠nimo del domingo: +3<br>
    1) Precio &gt; m√°ximo del domingo: +2 extra<br>
    2) En 15m RSI&gt;50 y precio&gt;EMA28: +2 | RSI&lt;50 y precio&lt;EMA28: -2<br>
    3) En 5m RSI&gt;70 y precio&gt;EMA28: +1 | RSI&lt;30 y precio&lt;EMA28: -1<br>
    4) En 4m RSI&lt;15: +0.5 | RSI&gt;85: -0.5<br>
    [Score limitado entre 1 y 10]
  </div>
  <div id="panel"><div style="text-align:center;padding:50px;">Cargando datos‚Ä¶</div></div>
  <div id="error-box"></div>
  <div id="alerts"></div>
  <script>
    // --- Configuraci√≥n ---
    const REFRESH_INTERVAL = 120 * 1000;
    const SYMBOL_LIMIT = 100; // top 100 por volumen
    const STABLES = /BUSD|USDT|USDC|TUSD|DAI|FDUSD|PYUSD|USDP|GUSD|USDN|EUR|GBP|BRL|TRY|RUB|UAH|IDRT|ZAR|VAI|SUSD|XAUT|BNBUSDT|BTCBUSD/;
    const ALERT_LIMIT = 20;
    // --- Utilidades ---
    function calcEMA(arr, period) {
      const k = 2 / (period + 1);
      return arr.reduce((a,v,i)=>i ? v*k + a*(1-k) : v, 0);
    }
    function calcRSI(arr) {
      let gains = 0, losses = 0;
      for (let i = 1; i < arr.length; i++) {
        let diff = arr[i] - arr[i-1];
        if (diff > 0) gains += diff;
        else losses -= diff;
      }
      const avgGain = gains/(arr.length-1), avgLoss = losses/(arr.length-1)||1e-6, rs = avgGain/avgLoss;
      return 100 - (100/(1+rs));
    }
    function clamp(n, min, max) { return Math.max(min, Math.min(n, max)); }
    function phaseText(score) {
      if (score <= 3.0) return 'üî¥ Oversold';
      else if (score < 4.9) return 'üî¥ Bearish Incline';
      else if (score < 6.0) return 'üü† Accumulation';
      else if (score < 8.1) return 'üü° Bullish Incline';
      else return 'üü¢ Overbought';
    }
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
    // --- Carga de datos principal ---
    let scoresPrev = JSON.parse(localStorage.getItem('ontraderScoresPrev')||'{}');
    let alerts = JSON.parse(localStorage.getItem('ontraderAlerts')||'[]');
    async function fetchJSON(url) {
      const resp = await fetch(url); if (!resp.ok) throw new Error("API error " + resp.status);
      return resp.json();
    }
    async function getTopSymbols() {
      // Top 100 por volumen de futuros (sin stables)
      let all = await fetchJSON("https://fapi.binance.com/fapi/v1/ticker/24hr");
      all = all
        .filter(s => s.symbol.endsWith('USDT') && !STABLES.test(s.symbol))
        .sort((a,b) => +b.quoteVolume - +a.quoteVolume)
        .slice(0, SYMBOL_LIMIT)
        .map(x => x.symbol);
      return all;
    }
    async function getSundayHighLow(symbol) {
      // Trae 4h velas para 10 d√≠as y saca max/min del domingo pasado
      let now = Date.now();
      let msPer4h = 4*60*60*1000;
      let start = now - 10*24*60*60*1000;
      let url = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=4h&startTime=${start}`;
      let data = await fetchJSON(url);
      let sundays = data.filter(d=>{
        let dt = new Date(+d[0]);
        return dt.getUTCDay()===0; // domingo UTC
      });
      let highs = sundays.map(k=>+k[2]), lows=sundays.map(k=>+k[3]);
      return {
        min: Math.min(...lows),
        max: Math.max(...highs)
      }
    }
    async function getCandleSet(symbol, interval, len) {
      let url = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${interval}&limit=${len}`;
      let data = await fetchJSON(url);
      return data.map(k => +k[4]); // cierre
    }
    async function getIndicators(symbol) {
      // [15m, 5m, 4m] para EMA, RSI
      let [closes15, closes5, closes4] = await Promise.all([
        getCandleSet(symbol,"15m",28), // para EMA28 y RSI14
        getCandleSet(symbol,"5m",28),
        getCandleSet(symbol,"4m",28)
      ]);
      let ema15 = calcEMA(closes15.slice(-28),28);
      let rsi15 = calcRSI(closes15.slice(-15));
      let last15 = closes15[closes15.length-1];
      let ema5 = calcEMA(closes5.slice(-28),28);
      let rsi5 = calcRSI(closes5.slice(-14));
      let last5 = closes5[closes5.length-1];
      let rsi4 = calcRSI(closes4.slice(-14));
      let last4 = closes4[closes4.length-1];
      return { ema15, rsi15, last15, ema5, rsi5, last5, rsi4, last4 }
    }
    async function getPanelData() {
      const symbols = await getTopSymbols();
      let out = [];
      for (let symbol of symbols) {
        try {
          let [ticker, sunday, ind] = await Promise.all([
            fetchJSON(`https://fapi.binance.com/fapi/v1/ticker/price?symbol=${symbol}`),
            getSundayHighLow(symbol),
            getIndicators(symbol)
          ]);
          // --- Score por tu f√≥rmula ---
          let score = 1, reasons = [];
          // 1) Precio > m√≠nimo del domingo: +3
          if (+ticker.price > sunday.min) { score += 3; reasons.push('>MinDom:+3'); }
          // 1) Precio > m√°ximo del domingo: +2 extra
          if (+ticker.price > sunday.max) { score += 2; reasons.push('>MaxDom:+2'); }
          // 2) 15m RSI>50 y precio>EMA28: +2  |  RSI<50 y precio<EMA28: -2
          if (ind.rsi15>50 && +ticker.price > ind.ema15) { score += 2; reasons.push('15mRSI>50&>EMA:+2'); }
          if (ind.rsi15<50 && +ticker.price < ind.ema15) { score -= 2; reasons.push('15mRSI<50&<EMA:-2'); }
          // 3) 5m RSI>70 y precio>EMA28: +1 | RSI<30 y precio<EMA28: -1
          if (ind.rsi5>70 && +ticker.price > ind.ema5) { score += 1; reasons.push('5mRSI>70&>EMA:+1'); }
          if (ind.rsi5<30 && +ticker.price < ind.ema5) { score -= 1; reasons.push('5mRSI<30&<EMA:-1'); }
          // 4) 4m RSI<15: +0.5 | RSI>85: -0.5
          if (ind.rsi4<15) { score += 0.5; reasons.push('4mRSI<15:+0.5'); }
          if (ind.rsi4>85) { score -= 0.5; reasons.push('4mRSI>85:-0.5'); }
          score = clamp(score, 1, 10);
          let prev = scoresPrev[symbol] || '';
          // Guarda el score previo (anterior run)
          scoresPrev[symbol] = score;
          out.push({
            symbol,
            price: +ticker.price,
            score,
            prev,
            phase: phaseText(score),
            reasons: reasons.join(', ')
          });
        } catch (e) {
          console.log("Error en",symbol,e);
        }
        await sleep(200); // para no saturar
      }
      // Persiste los scores previos
      localStorage.setItem('ontraderScoresPrev', JSON.stringify(scoresPrev));
      return out;
    }
    // --- Render y alertas ---
    function renderTable(data) {
      let html = `<table>
        <thead>
          <tr>
            <th>S√≠mbolo</th>
            <th>Precio</th>
            <th>Score</th>
            <th>Previo</th>
            <th>Fase</th>
            <th>Motivo Score</th>
          </tr>
        </thead><tbody>`;
      for (let d of data) {
        let cls = d.score>=8?'high':d.score>=5?'mid':'low';
        html += `<tr>
          <td>${d.symbol}</td>
          <td>${d.price.toFixed(6)}</td>
          <td class="${cls}">${d.score.toFixed(2)}</td>
          <td class="oldscore">${d.prev ? d.prev.toFixed(2) : '-'}</td>
          <td>${d.phase}</td>
          <td>${d.reasons}</td>
        </tr>`;
      }
      html += '</tbody></table>';
      return html;
    }
    function renderAlerts(data) {
      // Solo las alertas nuevas (cambios de fase o scores extremos)
      let now = Date.now();
      let newAlerts = [];
      for (let d of data) {
        let prev = d.prev ? parseFloat(d.prev) : null;
        if ((prev !== null && prev !== d.score) && (d.score >= 8 || d.score <= 3)) {
          newAlerts.push({
            time: now,
            symbol: d.symbol,
            score: d.score,
            prev: prev,
            phase: d.phase
          });
        }
      }
      alerts = [...newAlerts, ...alerts].slice(0, ALERT_LIMIT);
      localStorage.setItem('ontraderAlerts', JSON.stringify(alerts));
      let html = `<table id="alerts"><thead><tr>
        <th>Hora</th><th>S√≠mbolo</th><th>Score</th><th>Previo</th><th>Fase</th>
        </tr></thead><tbody>`;
      for (let a of alerts) {
        html += `<tr class="alert-row">
          <td>${new Date(a.time).toLocaleTimeString()}</td>
          <td>${a.symbol}</td>
          <td>${a.score.toFixed(2)}</td>
          <td>${a.prev ? a.prev.toFixed(2) : '-'}</td>
          <td>${a.phase}</td>
        </tr>`;
      }
      html += `</tbody></table>`;
      return html;
    }
    // --- Loop principal ---
    async function renderAll() {
      document.getElementById('panel').innerHTML = '<div style="text-align:center;padding:50px;">Cargando datos‚Ä¶</div>';
      document.getElementById('error-box').innerText = '';
      try {
        const data = await getPanelData();
        // Sort por score descendente
        data.sort((a,b) => b.score - a.score);
        document.getElementById('panel').innerHTML = renderTable(data);
        document.getElementById('alerts').innerHTML = renderAlerts(data);
      } catch (e) {
        document.getElementById('error-box').innerText = 'Error cargando datos: '+e.message;
      }
    }
    // --- Init ---
    renderAll();
    setInterval(renderAll, REFRESH_INTERVAL);
  </script>
</body>
</html>
