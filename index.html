<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>OnTrader Index Panel</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; background: #101729; color: #fff; font-family: 'Segoe UI', Arial, sans-serif;}
    h1 { margin: 0; padding: 10px; text-align: center; color: #25f0ff; font-size: 1.5rem;}
    h2 { color: #25f0ff; margin-top: 32px; margin-bottom: 12px; font-size: 1.15rem;}
    #panel { padding: 0 6px 30px 6px; }
    .loading { text-align: center; padding: 50px; font-size: 1.2rem; color: #888; }
    table { width: 100%; border-collapse: collapse; border-radius: 14px; overflow: hidden; margin: 12px 0 18px 0; background: #151d2b; box-shadow: 0 2px 10px #0002;}
    th, td { padding: 8px 4px; text-align: center; }
    thead { background: #232f4b; color: #25f0ff; font-weight: 600; font-size: 1rem;}
    tbody tr:nth-child(even) { background: #121a2a;}
    tbody tr:hover { background: #273250;}
    td.phase { font-size: 1.2rem; }
    td.high { color: #00ffae; font-weight: 700;}
    td.mid { color: orange;}
    td.low { color: #ff4455;}
    .score-up { background: linear-gradient(90deg,#003f1e 80%,#00ffae0f);}
    .score-down { background: linear-gradient(90deg,#3f0000 80%,#ff44551c);}
    .alert { color: #fff; background: #252f4c; }
    #error-box { text-align: center; color: #f55; padding: 5px; }
    @media (max-width:600px) {
      th, td { font-size: 0.86rem; padding: 7px 2px;}
      h1 { font-size: 1.1rem;}
    }
  </style>
</head>
<body>
  <h1>OnTrader Index Panel â€” Binance Futures</h1>
  <div id="panel"><div class="loading">Cargando datosâ€¦</div></div>
  <div id="error-box"></div>
  <script>
    const API = "https://fapi.binance.com";
    const STABLES = ['USDT','USDC','BUSD','TUSD','USDP','DAI','FDUSD','EUR','TRY','BRL','ARS','PYUSD'];
    const panel = document.getElementById('panel');
    const errorBox = document.getElementById('error-box');
    let prevScores = JSON.parse(localStorage.getItem('ontraderScores')||'{}');
    let alerts = [];
    const REFRESH_MS = 120000;

    function phaseText(s) {
      if (s <= 3.0) return 'ðŸ”´ Oversold';
      else if (s < 4.9) return 'ðŸ”´ Bearish Incline';
      else if (s < 6.0) return 'ðŸŸ  Accumulation';
      else if (s < 8.1) return 'ðŸŸ¡ Bullish Incline';
      else return 'ðŸŸ¢ Overbought';
    }

    // Score formula (dummy RSI/EMA/extremos: Â¡Reemplazar por tus valores reales!)
    function calcScore(d) {
      let score = 1;
      if (d.lastPrice > d.sunMin) score += 3;
      if (d.lastPrice > d.sunMax) score += 2;
      if (d.rsi15m > 50 && d.lastPrice > d.ema15m) score += 2;
      if (d.rsi15m < 50 && d.lastPrice < d.ema15m) score -= 2;
      if (d.rsi5m > 70 && d.lastPrice > d.ema5m) score += 1;
      if (d.rsi5m < 30 && d.lastPrice < d.ema5m) score -= 1;
      if (d.rsi4m < 15) score += 0.5;
      if (d.rsi4m > 85) score -= 0.5;
      return Math.max(1, Math.min(10, score));
    }

    function dummyRSI() { return Math.floor(Math.random()*100);}
    function dummyEMA(price) { return price*(0.99+Math.random()*0.02);}
    async function fetchWithProxy(url) {
      let errorMsg = '';
      const proxies = [u=>u, u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`, u=>`https://thingproxy.freeboard.io/fetch/${u}`];
      for (const wrap of proxies) {
        try {
          const resp = await fetch(wrap(url));
          const data = await resp.json();
          if (Array.isArray(data) || (typeof data === 'object' && data !== null)) return data;
        } catch(e) { errorMsg = e.message;}
      }
      throw new Error("No se pudo obtener datos de Binance. "+errorMsg);
    }

    async function loadData() {
      panel.innerHTML = '<div class="loading">Cargando datosâ€¦</div>';
      errorBox.innerText = '';
      try {
        const data = await fetchWithProxy(`${API}/fapi/v1/ticker/24hr`);
        if (!Array.isArray(data)) throw new Error("Respuesta inesperada de la API: " + JSON.stringify(data));
        let list = data.filter(d => d.symbol.endsWith("USDT") && !STABLES.some(st => d.symbol === st + "USDT"))
                       .sort((a, b) => b.quoteVolume - a.quoteVolume).slice(0, 100);
        for (let d of list) {
          d.lastPrice = parseFloat(d.lastPrice);
          d.rsi15m = dummyRSI(); d.ema15m = dummyEMA(d.lastPrice);
          d.rsi5m = dummyRSI(); d.ema5m = dummyEMA(d.lastPrice);
          d.rsi4m = dummyRSI();
          d.sunMin = d.lowPrice ? parseFloat(d.lowPrice) : d.lastPrice * 0.95;
          d.sunMax = d.highPrice ? parseFloat(d.highPrice) : d.lastPrice * 1.05;
        }
        // Calcular score y scorePrev
        const updatedPrevScores = {};
        list.forEach(d => {
          const prev = prevScores[d.symbol] || null;
          d.scorePrev = prev ? prev.score : '';
          d.score = calcScore(d);
          updatedPrevScores[d.symbol] = { score: d.score };
        });
        prevScores = updatedPrevScores;
        localStorage.setItem('ontraderScores', JSON.stringify(updatedPrevScores));

        // Cambios de score
        const upMoves = [], downMoves = [];
        list.forEach(d => {
          if (d.scorePrev !== '' && d.score > d.scorePrev) upMoves.push(d);
          if (d.scorePrev !== '' && d.score < d.scorePrev) downMoves.push(d);
        });

        // Top 10 Bullish / Bearish
        const top10Bull = list.slice().sort((a,b)=>b.score-a.score).slice(0,10);
        const top10Bear = list.slice().sort((a,b)=>a.score-b.score).slice(0,10);

        // Top cambios up/down
        const top10Up = upMoves.slice().sort((a,b)=>(b.score-b.scorePrev)-(a.score-a.scorePrev)).slice(0,10);
        const top10Down = downMoves.slice().sort((a,b)=>(a.score-a.scorePrev)-(b.score-b.scorePrev)).slice(0,10);

        // Alertas de cambios de fase
        alerts = [];
        list.forEach(d => {
          if (d.scorePrev !== '' && phaseText(d.scorePrev) !== phaseText(d.score)) {
            alerts.unshift({ time: new Date().toLocaleTimeString(), symbol: d.symbol, prev: phaseText(d.scorePrev), now: phaseText(d.score), score:d.score, scorePrev:d.scorePrev });
          }
        });
        if (alerts.length > 20) alerts = alerts.slice(0,20);

        renderTables(top10Bull, top10Bear, top10Up, top10Down, alerts);
      } catch(e) {
        errorBox.innerText = 'Error cargando datos: ' + e.message;
        panel.innerHTML = '';
      }
    }

    function makeTable(title, arr, opts={}) {
      let html = `<h2>${title}</h2><table><thead>
        <tr>
          <th>Symbol</th>
          <th>Last Price</th>
          <th>Score</th>
          <th>Prev Score</th>
          <th>Phase</th>
        </tr></thead><tbody>`;
      for (const d of arr) {
        let deltaClass = '';
        if (d.scorePrev !== '') deltaClass = d.score > d.scorePrev ? 'score-up' : (d.score < d.scorePrev ? 'score-down' : '');
        html += `<tr class="${deltaClass}">
          <td>${d.symbol}</td>
          <td>${d.lastPrice.toFixed(6)}</td>
          <td class="${d.score >= 8 ? 'high' : d.score >= 5 ? 'mid' : 'low'}">${d.score}</td>
          <td>${d.scorePrev}</td>
          <td class="phase">${phaseText(d.score)}</td>
        </tr>`;
      }
      html += '</tbody></table>';
      return html;
    }

    function makeAlertsTable(alerts) {
      let html = `<h2>Ãšltimas 20 Alertas</h2><table><thead>
        <tr><th>Hora</th><th>Symbol</th><th>Score Prev</th><th>Score</th><th>Fase Prev</th><th>Nueva Fase</th></tr></thead><tbody>`;
      for (const a of alerts)
        html += `<tr class="alert"><td>${a.time}</td><td>${a.symbol}</td><td>${a.scorePrev}</td><td>${a.score}</td><td>${a.prev}</td><td>${a.now}</td></tr>`;
      html += '</tbody></table>';
      return html;
    }

    function renderTables(top10Bull, top10Bear, top10Up, top10Down, alerts) {
      panel.innerHTML = 
        makeTable('Top 10 Alcista', top10Bull) +
        makeTable('Top 10 Bajista', top10Bear) +
        makeTable('Top 10 Cambios Score Al Alza', top10Up) +
        makeTable('Top 10 Cambios Score A La Baja', top10Down) +
        makeAlertsTable(alerts);
    }

    loadData();
    setInterval(loadData, REFRESH_MS);
  </script>
</body>
</html>
