// ... dentro del main() ...

try {
  // ...código anterior...

  let res = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
  let tickers = await res.json();
  console.log("Tickers recibidos:", tickers.length);

  tickers = tickers.filter(...); // tu filtro de stablecoins
  tickers = tickers.sort((a,b)=>parseFloat(b.quoteVolume)-parseFloat(a.quoteVolume)).slice(0, TOP_LIMIT);

  let results = [];
  let newPrevScores = {};
  let newAlerts = prevAlerts.slice();

  for (let t of tickers) {
    let symbol = t.symbol;
    let url = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${INTERVAL}&limit=100`;
    let klineRes = await fetch(url);
    let klines = await klineRes.json();
    if (!Array.isArray(klines) || klines.length < 30) {
      console.warn("No hay suficientes klines para", symbol, klines);
      continue;
    }
    let closes = klines.map(x=>parseFloat(x[4]));
    let ema28 = ema(closes.slice(-EMA_PERIOD-1), EMA_PERIOD);
    let rsi14 = rsi(closes.slice(-RSI_PERIOD-1), RSI_PERIOD);
    let lastPrice = parseFloat(t.lastPrice);

    // Sunday detection
    let minSunday=Infinity, maxSunday=-Infinity;
    let latestSunday=0;
    klines.forEach(arr=>{
      let ts = arr[0];
      let date = new Date(ts);
      if(date.getUTCDay()===0 && date.getTime()>latestSunday){
        latestSunday = date.setUTCHours(0,0,0,0);
      }
    });
    klines.forEach(arr=>{
      let ts = arr[0];
      let date = new Date(ts);
      if(date.getUTCDay()===0 && date.setUTCHours(0,0,0,0)===latestSunday){
        let low = parseFloat(arr[3]), high = parseFloat(arr[2]);
        if(low<minSunday) minSunday=low;
        if(high>maxSunday) maxSunday=high;
      }
    });
    if(minSunday===Infinity) {
      minSunday = Math.min(...klines.map(a=>parseFloat(a[3])));
      console.warn("No se encontró minSunday para", symbol, "usa:", minSunday);
    }
    if(maxSunday===-Infinity) {
      maxSunday = Math.max(...klines.map(a=>parseFloat(a[2])));
      console.warn("No se encontró maxSunday para", symbol, "usa:", maxSunday);
    }

    // Score
    let score = 1;
    if(lastPrice > minSunday) score+=3;
    if(lastPrice > ema28) score+=2;
    if(rsi14 > 55) score+=2;
    if(lastPrice < ema28) score-=2;
    if(rsi14 < 45) score-=2;
    if(lastPrice > maxSunday) score+=2;
    if(lastPrice < minSunday) score-=2;
    score = Math.max(1, Math.min(10, score));
    let phase = getPhase(score);

    // Logs para depuración:
    console.log(`SYM:${symbol} P:${lastPrice} EMA:${ema28.toFixed(4)} RSI:${rsi14.toFixed(2)} MinDom:${minSunday} MaxDom:${maxSunday} SCORE:${score} PHASE:${phase}`);

    // ...resto igual...
  }

  // ...el resto del código igual...
} catch(e) {
  document.getElementById('panel').innerHTML = '';
  document.getElementById('error').textContent = 'Error cargando datos: '+(e.message||e);
  console.error("ERROR GLOBAL:", e);
}
