<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>OnTrader Index Panel Debug</title>
  <style>
    body { background:#101729; color:#fff; font-family:sans-serif; }
    #logs { background:#181e34; max-width:800px; margin:10px auto; padding:10px; min-height:100px; font-size:0.97em;}
    .err { color:#ff6666; }
    #panel { max-width:900px; margin:20px auto; }
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #2c344e; padding:7px; text-align:center; }
    thead { background:#1f2a44; color:#25f0ff;}
  </style>
</head>
<body>
  <h1>Debug Binance Futures Panel</h1>
  <div id="logs"></div>
  <div id="panel"></div>
<script>
const API_BIN = 'https://fapi.binance.com';
const PROXY = 'https://api.allorigins.win/raw?url=';
const MAX_SYMBOLS = 10; // para test

function log(msg, err) {
  document.getElementById('logs').innerHTML += `<div${err?' class="err"':''}>${msg}</div>`;
}
function fetchProxy(url) {
  return fetch(PROXY + encodeURIComponent(url)).then(r => r.json());
}

async function getTopSymbols() {
  let tickers = await fetchProxy(API_BIN+'/fapi/v1/ticker/24hr');
  return tickers
    .filter(x=>!x.symbol.match(/USDT$|USDC$|BUSD$|TUSD$|DAI$|USDP$|GUSD$|USDN$|EUR$|FDUSD$/))
    .sort((a,b)=>b.quoteVolume-a.quoteVolume)
    .slice(0,MAX_SYMBOLS)
    .map(x=>({symbol:x.symbol, lastPrice:+x.lastPrice}));
}
async function getOHLC(symbol, interval, limit) {
  let url = `${API_BIN}/fapi/v1/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
  let arr = await fetchProxy(url);
  return arr.map(row=>+row[4]); // close
}
function ema(arr, p){let k=2/(p+1),e=arr[0];for(let i=1;i<arr.length;i++)e=arr[i]*k+e*(1-k);return e;}
function rsi(arr,p=14){let g=0,l=0;for(let i=1;i<arr.length;i++){let d=arr[i]-arr[i-1];d>0?g+=d:l-=d;}let ag=g/p,al=l/p||1e-8,rs=ag/al;return 100-100/(1+rs);}
function phaseText(score){if(score<=3)return'ðŸ”´ Oversold';if(score<4.9)return'ðŸ”´ Bearish Incline';if(score<6)return'ðŸŸ  Accumulation';if(score<8.1)return'ðŸŸ¡ Bullish Incline';return'ðŸŸ¢ Overbought';}

async function main() {
  log("Cargando top 10 sÃ­mbolos de futuros...");
  let symbols = await getTopSymbols();
  let rows = [];
  for(let s of symbols) {
    try {
      log("Procesando "+s.symbol+"...");
      let ohlcvD = await fetchProxy(`${API_BIN}/fapi/v1/klines?symbol=${s.symbol}&interval=1d&limit=40`);
      let ohlcv15 = await getOHLC(s.symbol,'15m',30);
      let ohlcv5 = await getOHLC(s.symbol,'5m',30);
      let ohlcv4 = await getOHLC(s.symbol,'4m',30);
      // Domingo min/max (igual a antes)
      let sundays = ohlcvD.filter(row=>{
        let ts=+row[0];
        let day=new Date(ts).getUTCDay();
        return day===0;
      });
      let closes = sundays.map(row=>+row[4]);
      let minSunday = Math.min(...closes), maxSunday = Math.max(...closes);
      let ema15 = ema(ohlcv15.slice(-28),28);
      let rsi15 = rsi(ohlcv15.slice(-15),14);
      let ema5 = ema(ohlcv5.slice(-28),28);
      let rsi5 = rsi(ohlcv5.slice(-14),14);
      let rsi4 = rsi(ohlcv4.slice(-14),14);
      // Score
      let score = 1;
      if(s.lastPrice > minSunday) score+=3;
      if(s.lastPrice > maxSunday) score+=2;
      if(rsi15>50 && s.lastPrice>ema15) score+=2;
      if(rsi15<50 && s.lastPrice<ema15) score-=2;
      if(rsi5>70 && s.lastPrice>ema5) score+=1;
      if(rsi5<30 && s.lastPrice<ema5) score-=1;
      if(rsi4<15) score+=0.5;
      if(rsi4>85) score-=0.5;
      score=Math.max(1,Math.min(10,score));
      let phase = phaseText(score);
      rows.push({symbol:s.symbol, lastPrice:s.lastPrice, score, phase});
    } catch(e) {
      log("Error en "+s.symbol+": "+e.message,true);
    }
  }
  // Render
  document.getElementById('panel').innerHTML = `<table>
    <thead><tr><th>Symbol</th><th>Last Price</th><th>Score</th><th>Phase</th></tr></thead>
    <tbody>
      ${rows.map(r=>`<tr>
        <td>${r.symbol}</td>
        <td>${r.lastPrice}</td>
        <td>${r.score}</td>
        <td>${r.phase}</td>
      </tr>`).join('')}
    </tbody>
  </table>`;
  log("Â¡Listo!");
}

main().catch(e=>log("Fallo global: "+e.message,true));
</script>
</body>
</html>
