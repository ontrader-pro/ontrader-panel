<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>OnTrader Index Panel</title>
  <style>
    html, body { margin:0; padding:0; background:#101729; color:#fff; font-family:sans-serif; }
    h1 { color:#25f0ff; text-align:center; font-size:1.5rem; }
    #formula, #error-box, #progress-log { text-align:center; color:#aaa; font-size:0.95rem; }
    #panel { max-width:1200px; margin:auto; }
    table { width:100%; border-collapse:collapse; margin:15px 0; background:#181e34;}
    th, td { border:1px solid #222a40; padding:7px; text-align:center; }
    thead { background:#1f2a44; color:#25f0ff; }
    .high { color:limegreen; font-weight:bold;}
    .mid { color:orange; }
    .low { color:red; }
    .highlight-bull { background:rgba(0,255,0,0.10); }
    .highlight-bear { background:rgba(255,0,0,0.11); }
    #alert-box { position:fixed; bottom:10px; right:10px; background:#ff4444; color:#fff; padding:8px 12px; border-radius:4px; display:none; z-index:1000;}
    .hidden { display:none !important; }
    #progress-log { color:#7ef9d0; }
  </style>
</head>
<body>
  <h1>OnTrader Index Panel (Binance Futures)</h1>
  <div id="formula">
    Score:<br>
    1) Precio &gt; m√≠nimo del domingo: +3<br>
    1) Precio &gt; m√°ximo del domingo: +2 extra<br>
    2) En 15m RSI&gt;50 y precio&gt;EMA28: +2 | RSI&lt;50 y precio&lt;EMA28: -2<br>
    3) En 5m RSI&gt;70 y precio&gt;EMA28: +1 | RSI&lt;30 y precio&lt;EMA28: -1<br>
    4) En 4m RSI&lt;15: +0.5 | RSI&gt;85: -0.5<br>
    [Score entre 1 y 10]
  </div>
  <div id="progress-log"></div>
  <div id="panel"><div class="loading">Cargando datos‚Ä¶</div></div>
  <div id="error-box"></div>
  <div id="alert-box"></div>
  <script>
    // --- Configuraci√≥n ---
    const API_BIN = 'https://fapi.binance.com';
    const CONFIG = {
      stables: /USDT$|USDC$|BUSD$|TUSD$|DAI$|USDP$|GUSD$|USDN$|EUR$|FDUSD$/,
      refreshInterval: 120000,
      minSundayLookback: 7, // d√≠as para detectar min/max domingo
      showColumns: ['symbol','lastPrice','score','scorePrev','phase'],
      MAX_SYMBOLS: 100
    };
    let panel = document.getElementById('panel');
    let errorBox = document.getElementById('error-box');
    let alertBox = document.getElementById('alert-box');
    let progressLog = document.getElementById('progress-log');
    let logs = [], alertTimeout;

    // --- Utilidades ---
    function log(...args) {
      let txt = args.join(' ');
      logs.push(txt);
      progressLog.innerText = txt;
      if (logs.length > 10) logs.shift();
    }
    function showError(msg) { errorBox.innerText = msg; }
    function showAlert(msg) {
      alertBox.innerText = 'üö® ' + msg;
      alertBox.style.display = 'block';
      clearTimeout(alertTimeout);
      alertTimeout = setTimeout(() => { alertBox.style.display = 'none'; }, 8000);
    }

    // --- Fetch robusto ---
    async function fetchJson(url) {
      let res = await fetch(url);
      if (!res.ok) throw new Error('HTTP '+res.status+' for '+url);
      return res.json();
    }

    // --- EMA y RSI ---
    function ema(arr, period) {
      let k = 2 / (period + 1), ema=arr[0];
      for (let i = 1; i < arr.length; i++) ema = arr[i]*k + ema*(1-k);
      return ema;
    }
    function rsi(arr, period=14) {
      let gains=0, losses=0;
      for (let i=1; i<arr.length; ++i) {
        let d = arr[i]-arr[i-1];
        d>0 ? gains+=d : losses-=d;
      }
      let avgGain = gains/period, avgLoss = losses/period||1e-8, rs = avgGain/avgLoss;
      return 100 - 100/(1+rs);
    }

    // --- Score y Phase ---
    function computeScore(row) {
      let score = 1;
      // 1. Domingo
      if (row.lastPrice > row.minSunday) score += 3;
      if (row.lastPrice > row.maxSunday) score += 2;
      // 2. 15m
      if (row.rsi15m > 50 && row.lastPrice > row.ema15m) score += 2;
      if (row.rsi15m < 50 && row.lastPrice < row.ema15m) score -= 2;
      // 3. 5m
      if (row.rsi5m > 70 && row.lastPrice > row.ema5m) score += 1;
      if (row.rsi5m < 30 && row.lastPrice < row.ema5m) score -= 1;
      // 4. 4m
      if (row.rsi4m < 15) score += 0.5;
      if (row.rsi4m > 85) score -= 0.5;
      score = Math.max(1, Math.min(10, score));
      return score;
    }
    function phaseText(score) {
      if (score <= 3.0) return 'üî¥ Oversold';
      if (score < 4.9) return 'üî¥ Bearish Incline';
      if (score < 6.0) return 'üü† Accumulation';
      if (score < 8.1) return 'üü° Bullish Incline';
      return 'üü¢ Overbought';
    }

    // --- OHLCV (close array) ---
    async function getOHLCV(symbol, interval, limit) {
      let url = `${API_BIN}/fapi/v1/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
      let arr = await fetchJson(url);
      return arr.map(row=>+row[4]); // close price
    }

    // --- Domingo min/max ---
    function getSundayRange(pricesDaily) {
      // Tomar velas de domingo (timestamp UTC, d√≠a 0)
      let sundays = pricesDaily.filter(row => {
        let ts = +row[0]; // openTime
        let day = new Date(ts).getUTCDay();
        return day===0;
      });
      let closes = sundays.map(row=>+row[4]);
      return {
        min: Math.min(...closes),
        max: Math.max(...closes)
      };
    }

    // --- Main data load ---
    async function loadData() {
      try {
        panel.innerHTML = '<div class="loading">Cargando datos‚Ä¶</div>';
        logs = [];
        showError('');
        log('Obteniendo lista de futuros de Binance...');
        // 1. S√≠mbolos de futuros, top 100 x cap (sin stablecoin)
        let tickers = await fetchJson(API_BIN+'/fapi/v1/ticker/24hr');
        let symbolsRaw = tickers
          .filter(x=>!x.symbol.match(CONFIG.stables))
          .sort((a,b)=>b.quoteVolume-a.quoteVolume)
          .slice(0,CONFIG.MAX_SYMBOLS)
          .map(x=>({symbol:x.symbol, lastPrice:+x.lastPrice}));
        log('Filtrados top 100 sin stablecoins. Comprobando OHLCV...');

        // 2. Recopila data completa (solo si todos los timeframes est√°n OK)
        let dataArr = [];
        let skipped = [];
        let scoreMapPrev = JSON.parse(localStorage.getItem('ontrader-score-prev')||"{}");
        for (let [i,symObj] of symbolsRaw.entries()) {
          try {
            log(`(${i+1}/${symbolsRaw.length}) ${symObj.symbol} - Cargando datos...`);
            // OHLCV diario (para domingos)
            let ohlcvD = await fetchJson(`${API_BIN}/fapi/v1/klines?symbol=${symObj.symbol}&interval=1d&limit=40`);
            // OHLCV intrad√≠a
            let [ohlcv15, ohlcv5, ohlcv4] = await Promise.all([
              getOHLCV(symObj.symbol, '15m', 30),
              getOHLCV(symObj.symbol, '5m', 30),
              getOHLCV(symObj.symbol, '4m', 30)
            ]);
            if ([ohlcvD, ohlcv15, ohlcv5, ohlcv4].some(x=>!Array.isArray(x)||x.length<20)) {
              log('Omitido por falta de data', symObj.symbol);
              skipped.push(symObj.symbol);
              continue;
            }
            // RSI/EMA
            let ema15 = ema(ohlcv15.slice(-28), 28);
            let rsi15 = rsi(ohlcv15.slice(-15), 14);
            let ema5 = ema(ohlcv5.slice(-28), 28);
            let rsi5 = rsi(ohlcv5.slice(-14), 14);
            let rsi4 = rsi(ohlcv4.slice(-14), 14);
            // Min/max domingo
            let sunday = getSundayRange(ohlcvD);
            let row = {
              symbol: symObj.symbol,
              lastPrice: symObj.lastPrice,
              minSunday: sunday.min, maxSunday: sunday.max,
              ema15m: ema15, rsi15m: rsi15,
              ema5m: ema5, rsi5m: rsi5,
              rsi4m: rsi4,
              scorePrev: scoreMapPrev[symObj.symbol]||'-'
            };
            row.score = computeScore(row);
            row.phase = phaseText(row.score);
            dataArr.push(row);
            scoreMapPrev[symObj.symbol] = row.score;
          } catch(e) {
            log('Omitido', symObj.symbol, e.message||e);
            skipped.push(symObj.symbol);
          }
        }
        // Actualiza scorePrev (guardar en localStorage)
        localStorage.setItem('ontrader-score-prev', JSON.stringify(scoreMapPrev));

        // 3. Alertas
        let prevAlerts = JSON.parse(localStorage.getItem('ontrader-alerts')||"[]");
        let alerts = [];
        for (let row of dataArr) {
          let prev = row.scorePrev!=='-' ? Number(row.scorePrev) : null;
          if (prev!==null && row.score!==prev && Math.abs(row.score-prev)>=2) {
            alerts.push({
              time: Date.now(),
              symbol: row.symbol,
              lastPrice: row.lastPrice,
              score: row.score,
              scorePrev: prev,
              phase: row.phase
            });
          }
        }
        // Mant√©n solo 20 √∫ltimas
        alerts = [...alerts, ...prevAlerts].sort((a,b)=>b.time-a.time).slice(0,20);
        localStorage.setItem('ontrader-alerts', JSON.stringify(alerts));

        // 4. Tablas
        log('Mostrando resultados...');
        renderTables(dataArr, alerts, skipped);

      } catch(e) {
        panel.innerHTML = '';
        showError('Error loading data: '+(e.message||e));
        log('Error loading data:', e);
      }
    }

    // --- Renderiza tablas ---
    function renderTables(dataArr, alerts, skipped) {
      // Top 10 alza y baja
      let topBull = dataArr.slice().sort((a,b)=>b.score-a.score).slice(0,10);
      let topBear = dataArr.slice().sort((a,b)=>a.score-b.score).slice(0,10);

      // Top cambios score al alza/baja
      let scoreUp = dataArr.filter(r=>Number(r.scorePrev)!=='-' && r.score>r.scorePrev)
                    .sort((
