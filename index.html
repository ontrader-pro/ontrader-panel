<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>OnTrader Index Panel</title>
  <style>
    /* Full screen reset for Blogger embed */
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    body { background: #101729; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; }
    h1 { margin: 0; padding: 10px; text-align: center; color: #25f0ff; font-size: 1.5rem; }
    #formula { text-align: center; color: #aaa; font-size: 0.9rem; padding-bottom: 10px; }
    #panel { flex: 1; overflow: auto; padding: 0 10px; }
    .loading { text-align: center; padding: 50px; font-size: 1.2rem; color: #888; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #333; padding: 6px; text-align: center; }
    thead { background: #1f2a44; color: #25f0ff; }
    .high { color: limegreen; }
    .mid { color: orange; }
    .low { color: red; }
    .highlight-bull { background: rgba(0,255,0,0.2); }
    .highlight-bear { background: rgba(255,0,0,0.2); }
    #alert-box { position: fixed; bottom: 10px; right: 10px; background: #ff4444; color: #fff; padding: 8px 12px; border-radius: 4px; display: none; z-index: 1000; }
    #error-box { text-align: center; color: #f55; padding: 5px; }
  </style>
</head>
<body>
  <h1>OnTrader Index Panel</h1>
  <div id="formula">Score = 1 + 2¬∑x‚ÇÅ + 2¬∑x‚ÇÇ + 3¬∑x‚ÇÉ + 2¬∑x‚ÇÑ</div>
  <div id="panel"><div class="loading">Cargando datos‚Ä¶</div></div>
  <div id="error-box"></div>
  <div id="alert-box"></div>

  <script>
    const panel = document.getElementById('panel');
    const errorBox = document.getElementById('error-box');
    const alertBox = document.getElementById('alert-box');
    const sound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
    const API_BASE = 'https://api.coingecko.com/api/v3';
    const TIMEOUT = 10000;
    const CONFIG = {
      stables: new Set(['USDT','USDC','BUSD','DAI','TUSD','USDP','GUSD','USDN']),
      perPage: 100,
      pages: 1,
      refreshInterval: 120000,
      oneHour: 3600000
    };
    let cache = [], durations = {}, alerts = [];

    async function fetchWithFallback(url) {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), TIMEOUT);
      const tryFetch = async target => {
        const resp = await fetch(target, { signal: controller.signal });
        if (!resp.ok) throw new Error(`Status ${resp.status}`);
        return resp.json();
      };
      try { return await tryFetch(url); } catch {};
      const proxies = [
        u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
        u => `https://thingproxy.freeboard.io/fetch/${u}`
      ];
      for (const proxy of proxies) {
        try { const data = await tryFetch(proxy(url)); clearTimeout(timer); return data; } catch {};
      }
      clearTimeout(timer);
      throw new Error('No se pudo obtener datos de la API');
    }

    function calcEMA(arr, p) { const k = 2/(p+1); return arr.reduce((a,v,i)=>i?v*k+a*(1-k):v,0); }
    function calcRSI(arr) { let g=0,l=0; for(let i=1;i<arr.length;i++){const d=arr[i]-arr[i-1]; d>0?g+=d:l-=d;} const ag=g/(arr.length-1), al=l/(arr.length-1)||1e-6, rs=ag/al; return 100-(100/(1+rs)); }
    function computeScore({price,minD,ema28,rsi14}) { const x1=+(price<minD), x2=+(price<ema28), x3=+(rsi14<50), x4=+(rsi14<30), raw=1+2*x1+2*x2+3*x3+2*x4; return Math.min(10,Math.max(1,raw)); }
    function phaseText(s) {
      if (s <= 3.0) return 'üî¥ Oversold';
      else if (s < 4.9) return 'üî¥ Bearish Incline';
      else if (s < 6.0) return 'üü† Accumulation';
      else if (s < 8.1) return 'üü° Bullish Incline';
      else return 'üü¢ Overbought';
    }

    async function loadData() {
      panel.innerHTML = '<div class="loading">Cargando datos‚Ä¶</div>';
      errorBox.innerText = '';
      try {
        const pages = [1];
        const results = await Promise.all(pages.map(pg => fetchWithFallback(
          `${API_BASE}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=${CONFIG.perPage}&page=${pg}&sparkline=true`
        )));
        let list = results.flat().slice(0,100);
        cache = list.filter(c=>c.symbol && !CONFIG.stables.has(c.symbol.toUpperCase()))
          .map(c=>{
            const sym=c.symbol.toUpperCase(); const prices=Array.isArray(c.sparkline_in_7d?.price)?c.sparkline_in_7d.price:[];
            return { symbol:sym, price:c.current_price, minD:c.low_24h, ema28:prices.length>=28?calcEMA(prices.slice(-28),28):c.current_price, rsi14:prices.length>=15?calcRSI(prices.slice(-15)):50 };
          });
        localStorage.setItem('ontraderCache', JSON.stringify(cache));
        renderAll();
      } catch(e) {
        console.error(e);
        const saved = localStorage.getItem('ontraderCache');
        if(saved){ cache=JSON.parse(saved); errorBox.innerText='Mostrando datos de cach√©'; renderAll(); }
        else { panel.innerHTML=''; errorBox.innerText='Error cargando datos: '+e.message; }
      }
    }

    function renderAll() {
      const now=Date.now(); alerts=[];
      cache.forEach(d=>{ d.score=computeScore(d); durations[d.symbol]||={}; if(d.score>=6) durations[d.symbol].bull||=now; else delete durations[d.symbol].bull; if(d.score<=3) durations[d.symbol].bear||=now; else delete durations[d.symbol].bear; const phase=phaseText(d.score); if((d.score>=6||d.score<=3)) alerts.push({time:now,symbol:d.symbol,phase}); });
      alerts = alerts.filter((v,i,a)=>a.findIndex(x=>x.symbol===v.symbol&&x.phase===v.phase)===i).slice(0,20);
      const sorted = cache.slice().sort((a,b)=>b.score-a.score);
      const top10=sorted.slice(0,10), bot10=sorted.slice(-10).reverse();
      const top5Bearish = cache.filter(d=>phaseText(d.score).includes('Bearish Incline')).sort((a,b)=>a.score-b.score).slice(0,5);
      const top5Accum = cache.filter(d=>phaseText(d.score).includes('Accumulation')).sort((a,b)=>b.score-a.score).slice(0,5);
      panel.innerHTML = `<h2>Top 10 Bullish</h2>${makeTable(top10)}<h2>Top 10 Bearish</h2>${makeTable(bot10)}<h2>Top 5 üî¥ Bearish Incline</h2>${makeTable(top5Bearish)}<h2>Top 5 üü† Accumulation</h2>${makeTable(top5Accum)}<h2>Last 20 Alerts</h2>${alertsTable()}`;
    }

    function makeTable(arr) {
      let html='<table><thead><tr><th>Symbol</th><th>Price</th><th>Score</th><th>Phase</th></tr></thead><tbody>';
      const now=Date.now(); arr.forEach(d=>{ const s=d.score, txt=s.toFixed(2); const cls=s>=8?'high':s>=5?'mid':'low'; const hl=durations[d.symbol].bull&&now-durations[d.symbol].bull>CONFIG.oneHour?'highlight-bull':durations[d.symbol].bear&&now-durations[d.symbol].bear>CONFIG.oneHour?'highlight-bear':''; html+=`<tr class="${hl}"><td>${d.symbol}</td><td>${d.price.toFixed(6)}</td><td class="${cls}">${txt}</td><td>${phaseText(s)}</td></tr>`; }); return html+'</tbody></table>'; }
    function alertsTable(){let html='<table><thead><tr><th>Time</th><th>Symbol</th><th>Phase</th></tr></thead><tbody>'; alerts.forEach(a=>html+=`<tr><td>${new Date(a.time).toLocaleTimeString()}</td><td>${a.symbol}</td><td>${a.phase}</td></tr>`); return html+'</tbody></table>';}    
    let alertTimeout; function showAlert(sym,ph){alertBox.innerText=`üö® ${sym}: ${ph}`; alertBox.style.display='block'; try{sound.currentTime=0;sound.play();}catch{} clearTimeout(alertTimeout); alertTimeout=setTimeout(()=>{sound.pause();alertBox.style.display='none';},8000);}    
    loadData(); setInterval(loadData, CONFIG.refreshInterval);
  </script>
</body>
</html>
