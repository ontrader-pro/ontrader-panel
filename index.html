<script>
  const pares = ["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT"];
  // Proxy CORS para Binance
  const proxy = url => 'https://thingproxy.freeboard.io/fetch/' + url;
  
  let dataGlobal = [], alerted = new Set();

  // Obtiene para un par el max/min de la vela diaria de domingo
  async function obtenerDomingo(par) {
    // Trae las Ãºltimas 8 velas diarias
    const url = `https://api.binance.com/api/v3/klines?symbol=${par}&interval=1d&limit=8`;
    const klines = await fetch(proxy(url)).then(r=>r.json());
    // Busca la mÃ¡s reciente cuyo getUTCDay()===0 (domingo UTC)
    const domingoK = klines.reverse().find(k => new Date(k[0]).getUTCDay() === 0);
    return {
      max: domingoK ? parseFloat(domingoK[2]) : NaN,
      min: domingoK ? parseFloat(domingoK[3]) : NaN
    };
  }

  async function actualizar() {
    const resultados = [];
    for (let par of pares) {
      try {
        // 1) Precio actual
        const p     = await fetch(proxy(`https://api.binance.com/api/v3/ticker/price?symbol=${par}`)).then(r=>r.json());
        const precio= parseFloat(p.price);

        // 2) Velas horarias para EMA/RSI
        const klH   = await fetch(proxy(`https://api.binance.com/api/v3/klines?symbol=${par}&interval=1h&limit=15`))
                              .then(r=>r.json());
        const cierres = klH.map(k=>parseFloat(k[4]));

        // 3) EMA28 y RSI14
        const ema = calcEMA(cierres.slice(-28), 28);
        const rsi = calcRSI(cierres);

        // 4) MÃX / MÃN de domingo
        const {max, min} = await obtenerDomingo(par);

        // 5) CÃ¡lculo del Ãndice OnTrader
        let score = 0;
        if (precio > min) score += 1;
        if (precio > (min + max)/2) score += 2;
        if (precio > max) score += 2;
        if (precio < min) score += 2;
        if ((precio % 1) < 0.2) score += 1;
        if (precio > ema) score += 2;
        if (rsi > 60 || rsi < 40) score += 2.5;
        score = Math.min(10, Math.max(1, score));

        // 6) Alerta
        const alerta = score >= 7
          ? `ðŸš¨ ${par.replace('USDT','')} Ãndice ${score}`
          : '-';

        resultados.push({
          cripto: par.replace('USDT',''),
          precio,
          indice: score,
          alerta
        });
      } catch(e) {
        console.warn('Error con', par, e);
      }
    }
    dataGlobal = resultados;
    renderTabla();
    mostrarAlerta();
  }

  function calcEMA(vals, period) {
    const k = 2/(period + 1);
    return vals.reduce((acc, v, i) => i
      ? v*k + acc*(1-k)
      : v
    );
  }

  function calcRSI(arr) {
    let gains=0, losses=0;
    for (let i=1; i<arr.length; i++){
      const d = arr[i] - arr[i-1];
      if (d>0) gains += d;
      else losses -= d;
    }
    const avgG = gains/(arr.length-1);
    const avgL = losses/(arr.length-1) || 1e-6;
    const rs = avgG/avgL;
    return 100 - (100/(1+rs));
  }

  // renderTabla() y mostrarAlerta() quedan igualâ€¦
  document.getElementById('buscar').addEventListener('input', renderTabla);
  document.getElementById('orden').addEventListener('change', renderTabla);

  // Primera carga
  actualizar();
  setInterval(actualizar, 30000);
</script>
