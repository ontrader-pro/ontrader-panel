<script>
  // 1) CONFIG
  const STABLES = ['usdt','usdc','busd','dai','tusd','usdp','gusd','usdn'];
  const CG_URL = 'https://api.coingecko.com/api/v3/coins/markets'
               + '?vs_currency=usd&order=market_cap_desc&per_page=200&page=1&sparkline=true';
  const proxy  = url => 'https://thingproxy.freeboard.io/fetch/' + url;

  // 2) HELPERS
  function calcEMA(vals,p){ const k=2/(p+1); return vals.reduce((a,v,i)=> i? v*k + a*(1-k): v, 0); }
  function calcRSI(arr){ let g=0,l=0; for(let i=1;i<arr.length;i++){ const d=arr[i]-arr[i-1]; d>0?g+=d:l-=d;} const avgG=g/(arr.length-1), avgL=l/(arr.length-1)||1e-6, rs=avgG/avgL; return 100-(100/(1+rs)); }

  let dataGlobal = [], alerted = new Set();

  // 3) HEAVY LOAD (EMA/RSI/Domingo) PROTEGIDO
  async function heavyLoad(){
    try {
      const cg = await fetch(CG_URL).then(r=>r.json());
      const arr = cg.filter(c=>!STABLES.includes(c.symbol.toLowerCase()));
      const data = await Promise.all(arr.map(async c=>{
        // sparkline
        const closes7 = Array.isArray(c.sparkline_in_7d?.price) 
          ? c.sparkline_in_7d.price 
          : [];
        const ema28 = closes7.length >= 28 ? calcEMA(closes7.slice(-28),28) : c.current_price;
        const rsi14 = closes7.length >= 15 ? calcRSI(closes7.slice(-15)) : 50;
        // vela diaria domingo
        let maxD=NaN, minD=NaN;
        try {
          const kl = await fetch(
            proxy(`https://api.binance.com/api/v3/klines?symbol=${c.symbol.toUpperCase()}USDT&interval=1d&limit=8`)
          ).then(r=>r.json());
          const found = kl.reverse().find(k=>new Date(k[0]).getUTCDay()===0) || [];
          maxD = parseFloat(found[2])||NaN;
          minD = parseFloat(found[3])||NaN;
        } catch(e) {
          console.warn('domingo err',c.symbol,e);
        }
        return {
          symbol: c.symbol.toUpperCase(),
          ema28, rsi14, maxD, minD
        };
      }));
      return data;
    } catch(e) {
      console.error('heavyLoad failed',e);
      // Fallback: solo s√≠mbolos con valores neutros
      const cg = await fetch(CG_URL).then(r=>r.json());
      return cg.filter(c=>!STABLES.includes(c.symbol))
        .map(c=>({
          symbol: c.symbol.toUpperCase(),
          ema28: c.current_price,
          rsi14: 50,
          maxD: c.current_price,
          minD: c.current_price
        }));
    }
  }

  // 4) LIGHT LOAD (precios + index) SIEMPRE SE EJECUTA
  async function lightLoad(heavy){
    try {
      const ids = heavy.map(h=>h.symbol.toLowerCase()).join(',');
      const prices = await fetch(
        `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`
      ).then(r=>r.json());
      dataGlobal = heavy.map(h=>{
        const precio = prices[h.symbol.toLowerCase()]?.usd || 0;
        let score = 0;
        if(!isNaN(h.minD) && precio > h.minD)             score += 1;
        if(!isNaN(h.minD)&&!isNaN(h.maxD)&&precio > (h.minD+h.maxD)/2) score += 2;
        if(!isNaN(h.maxD) && precio > h.maxD)             score += 2;
        if(!isNaN(h.minD) && precio < h.minD)             score += 2;
        if((precio % 1) < 0.2)                            score += 1;
        if(precio > h.ema28)                              score += 2;
        if(h.rsi14 > 50)                                  score += 1;
        if(h.rsi14 < 50)                                  score -= 1;
        score = Math.min(10, Math.max(1, score));
        let fase = 'üî¥ Debilidad excesiva';
        if     (score >= 8.1) fase = 'üü¢ Fuerza excesiva';
        else if(score >= 6.0) fase = 'üü° Inclinaci√≥n alcista';
        else if(score >= 4.9) fase = 'üü† Acumulaci√≥n';
        else if(score >= 3.1) fase = 'üî¥ Inclinaci√≥n bajista';
        return { cripto: h.symbol, precio, indice: score.toFixed(1), fase };
      });
    } catch(e) {
      console.error('lightLoad failed', e);
      dataGlobal = [];
    }
    renderTables();
    mostrarAlertas();
  }

  // 5) RENDER TOP/BOTTOM 10
  function renderTables(){
    const top = dataGlobal.slice().sort((a,b)=>b.indice-a.indice).slice(0,10);
    const bot = dataGlobal.slice().sort((a,b)=>a.indice-b.indice).slice(0,10);
    const mk = arr=>`
      <table><thead>
        <tr><th>Cripto</th><th>Precio</th><th>√çndice</th><th>Fase</th></tr>
      </thead><tbody>
        ${arr.map(d=>`
          <tr>
            <td>${d.cripto}</td>
            <td>${d.precio.toLocaleString()}</td>
            <td class="${d.indice>=8?'high':d.indice>=5?'mid':'low'}">${d.indice}</td>
            <td>${d.fase}</td>
          </tr>`).join('')}
      </tbody></table>`;
    document.getElementById('panel').innerHTML =
      `<h2>Top 10 Alcistas</h2>${mk(top)}<h2>Top 10 Bajistas</h2>${mk(bot)}`;
  }

  // 6) ALERTAS (‚â•6 o ‚â§3)
  function mostrarAlertas(){
    const el = document.getElementById('alerta');
    const n  = dataGlobal.find(d=>!alerted.has(d.cripto)&&(d.indice>=6||d.indice<=3));
    if(n){
      alerted.add(n.cripto);
      el.innerText = `üö® ${n.cripto}: ${n.fase}`;
      el.style.display = 'block';
      new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
      setTimeout(()=> el.style.display='none',10000);
    }
  }

  // 7) ORQUESTACI√ìN: heavyLoad ‚Üí lightLoad ‚Üí refresh ligero cada 60s
  (async ()=>{
    const heavy = await heavyLoad();      // SIEMPRE RESUELVE
    await lightLoad(heavy);               // SIEMPRE SE EJECUTA
    setInterval(()=>lightLoad(heavy),60000);
  })();
  </script>
